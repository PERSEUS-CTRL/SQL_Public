WITH ARR_ID AS (
SELECT RECID,LINKED_APPL_ID FROM V_FBNK_AA_ARRANGEMENT WHERE LINKED_APPL_ID IN (
'100016915',
'100020718',
'100030818',
'100040786',
'100066278',
'100021358',
'100056787',
'100091418',
'100089661',
'100089707',
'100002183',
'100002148',
'100002205',
'100001853',
'100000188',
'100000137',
'100001829',
'100001977',
'100001918',
'100052237',
'100052199',
'100074524',
'100074548',
'100074508',
'100070669',
'100070658',
'100096862',
'100096846',
'100066394',
'100052326',
'100052369',
'100052423',
'100070472',
'100049527',
'100044455',
'100043297',
'100054598',
'100054604',
'100021315',
'100021487',
'100021331',
'100021471',
'100028735',
'100028727',
'100051982',
'100052008',
'100053136',
'100053896',
'100053934',
'100052617',
'100064553',
'100064588',
'100066777',
'100066726',
'100066661',
'100003171',
'100003082',
'100003128',
'100003098',
'100066572',
'100066505',
'100063368',
'100063557',
'100042894',
'100072742',
'100066351',
'100066378',
'100023668',
'100077833',
'100073048',
'100073056',
'100036967',
'100036991',
'100055813',
'100055821',
'100039532',
'100039524',
'100095637',
'100095688',
'100091887',
'100091917',
'100069296',
'100079275'
) )
SELECT C.LINKED_APPL_ID AS ACCT, A.ID_COMP_1 AS ARR,A.ID_COMP_3, A.RECID AS ARR_ACCT, A.ACTIVITY, A.RATE_TIER_TYPE,A.THE_RECORD.value('(//c14)[1]','varchar(255)') as EURIBOR, A.THE_RECORD.value('(//c23)[1]','varchar(255)') as MARGIN,A.THE_RECORD.value('(//c27)[1]','varchar(255)') AS RATE
FROM V_FBNK_AA_ARR_INTEREST A 
JOIN ARR_ID C ON A.ID_COMP_1 = C.RECID 
WHERE A.ID_COMP_1 IN (
SELECT RECID FROM ARR_ID
)
AND CONVERT(decimal(10,2),A.ID_COMP_3) >= 20240101.0
AND CONVERT(decimal(10,2),A.ID_COMP_3) < 20240701.0
AND (A.RECID LIKE '%PRINCIPALINT%')
AND A.ACTIVITY = 'LENDING-PERIODIC.RESET-PRINCIPALINT'




--IMPORT RESET_ACCT

CREATE TABLE #TEMPDBSIL (
ARR VARCHAR(200),
ID_COMP_3 VARCHAR(200),
ARR_ACCT VARCHAR(200),
ACTIVITY VARCHAR(200),
RATE_TIER_TYPE VARCHAR(200),
EURIBOR VARCHAR(200),
MARGIN VARCHAR(200),
RATE VARCHAR(200)
)

CREATE TABLE #TEMPDBUSE (
ARR VARCHAR(200),
ID_COMP_3 VARCHAR(200),
ARR_ACCT VARCHAR(200),
ACTIVITY VARCHAR(200),
RATE_TIER_TYPE VARCHAR(200),
EURIBOR VARCHAR(200),
MARGIN VARCHAR(200),
RATE VARCHAR(200)
)
SELECT * FROM RESET_ACCT
SELECT * FROM #TEMPDBSIL
SELECT * FROM V_FBNK_AA_ARR_INTEREST WHERE ID_COMP_1 = 'AA221520VP1K'
---------------------------
DECLARE 
   @MAXCOMP DECIMAL(12,2), 
   @ARR1 VARCHAR(200)='',
   @SQL NVARCHAR(MAX) = ''
;


DECLARE CUR CURSOR FOR 
SELECT  ARR, ID_COMP_3 
FROM RESET_ACCT;

OPEN CUR;
FETCH NEXT FROM CUR INTO @ARR1, @MAXCOMP;


WHILE @@FETCH_STATUS = 0
BEGIN

   SELECT @SQL = 'INSERT INTO #TEMPDBUSE 
                  SELECT ID_COMP_1 COLLATE Latin1_General_BIN2, 
                         ID_COMP_3 COLLATE Latin1_General_BIN2, 
                         RECID, ACTIVITY, RATE_TIER_TYPE,
                         THE_RECORD.value(''(//c14)[1]'',''varchar(255)''),
                         THE_RECORD.value(''(//c23)[1]'',''varchar(255)''),
                         THE_RECORD.value(''(//c27)[1]'',''varchar(255)'')
                  FROM V_FBNK_AA_ARR_INTEREST
                  WHERE ID_COMP_1 = ''' + @ARR1 + ''' 
                  AND CONVERT(DECIMAL(18,2), ID_COMP_3) < ' + CAST(@MAXCOMP AS NVARCHAR)
				  + ' AND ID_COMP_2 = ''PRINCIPALINT''';

   EXEC sp_executesql @SQL;
   INSERT INTO #TEMPDBSIL
   SELECT B.*
   FROM #TEMPDBUSE B
   INNER JOIN (
      SELECT ARR COLLATE Latin1_General_BIN2 AS ID_COMP_1, 
             MAX(ID_COMP_3) AS MAXCOMP2
      FROM #TEMPDBUSE
      WHERE ARR COLLATE Latin1_General_BIN2 = @ARR1 COLLATE Latin1_General_BIN2
      GROUP BY ARR
   ) AS C 
   ON B.ARR COLLATE Latin1_General_BIN2 = C.ID_COMP_1 
   AND B.ID_COMP_3 COLLATE Latin1_General_BIN2 = C.MAXCOMP2;

   DELETE FROM #TEMPDBUSE;
   SELECT @SQL = '';

   FETCH NEXT FROM CUR INTO @ARR1, @MAXCOMP;
END;

CLOSE CUR;
DEALLOCATE CUR;

--SELECT TOP 1 * FROM RESET_ACCT
--SELECT * FROM #TEMPDBUSE
--SELECT * FROM #TEMPDBSIL
--DELETE FROM #TEMPDBSIL
--SELECT @SQL