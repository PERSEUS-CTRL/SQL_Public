WITH ARR_ID AS (
    SELECT * 
    FROM V_FBNK_AA_ARRANGEMENT 
    WHERE ARR_STATUS IN ('AUTH', 'CURRENT')
    AND PRODUCT IN (
        'MT.WORKING.CAPITAL', 'MT.REAL.ESTATE.LOAN', 
        'MT.PROJ.FINANC.LOAN', 'MT.MDB.LOANS', 'MT.INVESTMENT,LOAN',
        'MT.HOME.LOAN', 'MT.EQUITY.RELEASE'       
    )
)
SELECT ALISA.ID_COMP_1 AS ARRANGEMENT, ANDRIUS.LINKED_APPL_ID AS ACCOUNT, ANDRIUS.ARR_STATUS, ANDRIUS.CUSTOMER,
ANDRIUS.PRODUCT,ALISA.THE_RECORD.value('(//c23)[1]','varchar(50)') AS MARGIN_RATE,
ALISA.THE_RECORD.value('(//c27)[1]','varchar(50)') AS EFFECTIVE_RATE,
ALISA.THE_RECORD.value('(//c60)[1]','varchar(50)') AS CAPPING
FROM V_FBNK_AA_ARR_INTEREST ALISA
INNER JOIN (
    SELECT ID_COMP_1, MAX(CONVERT(DECIMAL(9,1), SUBSTRING(RECID, CHARINDEX('-', RECID, CHARINDEX('-', RECID) + 1) + 1, LEN(RECID)))) AS MAXITERATION
    FROM V_FBNK_AA_ARR_INTEREST
       WHERE SUBSTRING(RECID, CHARINDEX('-', RECID) + 1, CHARINDEX('-', RECID, CHARINDEX('-', RECID) + 1) - CHARINDEX('-', RECID) - 1) = 'PENALINT'
       AND CONVERT(DECIMAL(9,1), SUBSTRING(RECID, CHARINDEX('-', RECID, CHARINDEX('-', RECID) + 1) + 1, LEN(RECID))) <=  20240516
    GROUP BY ID_COMP_1
) AS KERRIANNE
ON ALISA.ID_COMP_1 = KERRIANNE.ID_COMP_1
AND CONVERT(DECIMAL(9,1), SUBSTRING(ALISA.RECID, CHARINDEX('-', ALISA.RECID, CHARINDEX('-', ALISA.RECID) + 1) + 1, LEN(ALISA.RECID))) = KERRIANNE.MAXITERATION
JOIN ARR_ID ANDRIUS
ON ALISA.ID_COMP_1 = ANDRIUS.RECID
WHERE ALISA.ID_COMP_1 IN (SELECT RECID FROM ARR_ID)
AND SUBSTRING(ALISA.RECID, CHARINDEX('-', ALISA.RECID) + 1, CHARINDEX('-', ALISA.RECID, CHARINDEX('-', ALISA.RECID) + 1) - CHARINDEX('-', ALISA.RECID) - 1) = 'PENALINT'
