WITH ARR_ID AS (
    SELECT * 
    FROM V_FBNK_AA_ARRANGEMENT 
    WHERE ARR_STATUS IN ('AUTH', 'CURRENT','REVERSED')
    AND PRODUCT IN (
        'MT.WORKING.CAPITAL', 'MT.REAL.ESTATE.LOAN', 
        'MT.PROJ.FINANC.LOAN', 'MT.MDB.LOANS', 'MT.INVESTMENT,LOAN',
        'MT.HOME.LOAN', 'MT.EQUITY.RELEASE'
    )
)
--SELECT * FROM ARR_ID
SELECT RECID AS ARR_ID, LINKED_APPL_ID AS ACCOUNT, CUSTOMER, ARR_STATUS, PRODUCT,PRODUCT_GROUP, PRODUCT_LINE FROM V_FBNK_AA_ARRANGEMENT WHERE
PRODUCT IN (--453
        'MT.WORKING.CAPITAL', 'MT.REAL.ESTATE.LOAN', 
        'MT.PROJ.FINANC.LOAN', 'MT.MDB.LOANS', 'MT.INVESTMENT,LOAN',
        'MT.HOME.LOAN', 'MT.EQUITY.RELEASE'
    ) AND ARR_STATUS IN ('REVERSED')*/
SELECT D1.ID_COMP_1 AS ARRANGEMENT,D3.LINKED_APPL_ID AS ACCOUNT, D3.ARR_STATUS AS STATUS1, D3.CUSTOMER, D3.PRODUCT,
D3.CURRENCY,D1.THE_RECORD.value('(//c10)[1]','varchar(50)') AS Floating_Rate,
CASE 
    WHEN D1.THE_RECORD.value('(//c10)[1]', 'varchar(50)') = '1' THEN 4.7
    WHEN D1.THE_RECORD.value('(//c10)[1]', 'varchar(50)') = '21' THEN 4.7
    WHEN D1.THE_RECORD.value('(//c10)[1]', 'varchar(50)') = '22' THEN 3.49
    ELSE NULL
       END AS Floating_Conv,
D1.THE_RECORD.value('(//c14)[1]','varchar(50)') AS Base_Rate,D1.THE_RECORD.value('(//c23)[1]','varchar(50)') AS Margin_Rate, 
D1.THE_RECORD.value('(//c27)[1]','varchar(50)') AS Effective_Rate,
D1.THE_RECORD.value('(//c60)[1]','varchar(50)') AS Max_Rate
--CASE
   -- WHEN D1.THE_RECORD.value('(//c10)[1]', 'varchar(50)') IS NULL THEN CONVERT(decimal(9,3), D1.THE_RECORD.value('(//c14)[1]', 'varchar(50)')) + CONVERT(decimal(9,3), D1.THE_RECORD.value('(//c23)[1]', 'varchar(50)'))
   -- WHEN D1.THE_RECORD.value('(//c14)[1]', 'varchar(50)') IS NULL THEN Floating_Conv + CONVERT(decimal(9,3), D1.THE_RECORD.value('(//c23)[1]', 'varchar(50)'))
   -- ELSE NULL
      -- END AS Calc_Rate
FROM V_FBNK_AA_ARR_INTEREST D1--408
INNER JOIN (
    SELECT ID_COMP_1, MAX(CONVERT(DECIMAL(9,1), SUBSTRING(RECID, CHARINDEX('-', RECID, CHARINDEX('-', RECID) + 1) + 1, LEN(RECID)))) AS MAXITERATION
    FROM V_FBNK_AA_ARR_INTEREST
	WHERE SUBSTRING(RECID, CHARINDEX('-', RECID) + 1, CHARINDEX('-', RECID, CHARINDEX('-', RECID) + 1) - CHARINDEX('-', RECID) - 1) = 'PRINCIPALINT'
	AND CONVERT(DECIMAL(9,1), SUBSTRING(RECID, CHARINDEX('-', RECID, CHARINDEX('-', RECID) + 1) + 1, LEN(RECID))) <=  20240516
    GROUP BY ID_COMP_1
) AS D2 
ON D1.ID_COMP_1 = D2.ID_COMP_1 
AND CONVERT(DECIMAL(9,1), SUBSTRING(D1.RECID, CHARINDEX('-', D1.RECID, CHARINDEX('-', D1.RECID) + 1) + 1, LEN(D1.RECID))) = D2.MAXITERATION
JOIN ARR_ID D3
ON D1.ID_COMP_1 = D3.RECID
WHERE D1.ID_COMP_1 IN (SELECT RECID FROM ARR_ID)
AND SUBSTRING(D1.RECID, CHARINDEX('-', D1.RECID) + 1, CHARINDEX('-', D1.RECID, CHARINDEX('-', D1.RECID) + 1) - CHARINDEX('-', D1.RECID) - 1) = 'PRINCIPALINT'
